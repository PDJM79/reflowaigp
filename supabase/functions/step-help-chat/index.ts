import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const openAIApiKey = Deno.env.get('OPENAI_API_KEY');

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { message, stepTitle, stepDescription, processName, conversationHistory } = await req.json();

    if (!message) {
      throw new Error('Message is required');
    }

    // Create system prompt with context about the step
    const systemPrompt = `You are a helpful assistant providing guidance for medical practice compliance processes. 

Current Context:
- Process: ${processName || 'Unknown Process'}
- Step: ${stepTitle || 'Unknown Step'}
- Step Description: ${stepDescription || 'No description available'}

You are helping a user complete this specific step in their compliance process. Provide clear, actionable guidance related to:
- How to properly complete this step
- What evidence might be needed
- Common issues and solutions
- Best practices for compliance
- Any regulatory requirements

Keep your responses focused, practical, and specific to the current step. If the user asks about something unrelated to the current process step, gently redirect them back to the task at hand.`;

    // Build messages array with conversation history
    const messages = [
      { role: 'system', content: systemPrompt },
      ...(conversationHistory || []),
      { role: 'user', content: message }
    ];

    console.log('Sending request to OpenAI with context:', {
      processName,
      stepTitle,
      messageCount: messages.length
    });

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openAIApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4.1-2025-04-14',
        messages: messages,
        max_completion_tokens: 800,
        stream: false
      }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error('OpenAI API error:', errorData);
      throw new Error(`OpenAI API error: ${errorData.error?.message || 'Unknown error'}`);
    }

    const data = await response.json();
    const aiResponse = data.choices[0].message.content;

    console.log('Received response from OpenAI, length:', aiResponse?.length);

    return new Response(JSON.stringify({ 
      response: aiResponse,
      usage: data.usage 
    }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });

  } catch (error) {
    console.error('Error in step-help-chat function:', error);
    return new Response(JSON.stringify({ 
      error: error.message || 'An unexpected error occurred'
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  }
});